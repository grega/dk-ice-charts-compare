<%= erb :_nav, locals: { active_page: 'compare', show_reset: true, reset_url: '/', subtitle: 'Select two dates and compare charts from each' } %>
<div class="container">
  <div class="pdf-container">
    <!-- select PDF for the first iframe -->
    <form id="pdfForm1">
      <select name="pdf_url" id="pdfSelect1">
        <% pdf_urls.each_with_index do |pdf_url, index| %>
          <option value="<%= pdf_url %>" <%= 'selected' if pdf_url == left_pdf_url %>><%= dates[index] %></option>
        <% end %>
      </select>
      <button type="submit">View chart</button>
    </form>

    <div class="iframe-wrapper">
      <div class="loading-spinner" id="loading1"></div>
      <iframe id="pdfIframe1"<% if left_pdf_url %> src="/pdf_to_jpg?pdf_url=<%= CGI.escape(left_pdf_url) %>" <% end %>></iframe>
    </div>
  </div>

  <div class="pdf-container">
    <!-- select PDF for the second iframe -->
    <form id="pdfForm2">
      <select name="pdf_url" id="pdfSelect2">
        <% pdf_urls.each_with_index do |pdf_url, index| %>
          <option value="<%= pdf_url %>" <%= 'selected' if pdf_url == right_pdf_url %>><%= dates[index] %></option>
        <% end %>
      </select>
      <button type="submit">View chart</button>
    </form>

    <div class="iframe-wrapper">
      <div class="loading-spinner" id="loading2"></div>
      <iframe id="pdfIframe2"<% if right_pdf_url %> src="/pdf_to_jpg?pdf_url=<%= CGI.escape(right_pdf_url) %>" <% end %>></iframe>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const showLoading = (loaderId) => {
      const loader = document.getElementById(loaderId);
      if (loader) loader.style.display = 'block';
    };

    const hideLoading = (loaderId) => {
      const loader = document.getElementById(loaderId);
      if (loader) loader.style.display = 'none';
    };

    const handleFormSubmit = (formId, selectId, iframeId, loaderId, paramName) => {
      const form = document.querySelector(formId);
      const select = document.querySelector(selectId);
      const iframe = document.querySelector(iframeId);

      if (!form || !select || !iframe) return;

      iframe.addEventListener('load', () => hideLoading(loaderId));

      form.addEventListener('submit', (event) => {
        event.preventDefault();

        showLoading(loaderId);
        const selectedPdfUrl = select.value;
        iframe.setAttribute('src', `/pdf_to_jpg?pdf_url=${encodeURIComponent(selectedPdfUrl)}`);

        // update the URL with the PDF for each (left/right) frame
        const url = new URL(window.location);
        const selectedDate = select.options[select.selectedIndex]?.text || '';
        url.searchParams.set(`${paramName}_date`, selectedDate);
        window.history.replaceState({}, '', url);
      });
    };

    handleFormSubmit('#pdfForm1', '#pdfSelect1', '#pdfIframe1', 'loading1', 'left');
    handleFormSubmit('#pdfForm2', '#pdfSelect2', '#pdfIframe2', 'loading2', 'right');

    // hide initial loading spinners when iframes load
    document.getElementById('pdfIframe1')?.addEventListener('load', () => hideLoading('loading1'));
    document.getElementById('pdfIframe2')?.addEventListener('load', () => hideLoading('loading2'));
  });
</script>
